<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Energ√≠a Chile</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
    :root {
        --primary-green: #2e7d32; /* Verde oscuro tipo Electricity Maps */
        --bg-light: #f4f4f4;
        --text-dark: #333;
    }

    body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: var(--text-dark); }
    
    /* SIDEBAR */
    #sidebar { 
        width: 400px; 
        background: white; 
        border-right: 1px solid #ddd; 
        display: flex; 
        flex-direction: column;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }

    /* HEADER */
    .sidebar-header {
        padding: 15px 20px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #eee;
    }
    .back-btn { margin-right: 15px; cursor: pointer; font-size: 1.2em; color: #666; }
    .header-title { font-weight: bold; font-size: 1.1em; flex: 1; }

    /* CONTENIDO CON SCROLL */
    .sidebar-content {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    /* TOGGLE (Interruptor) */
    .toggle-container {
        background-color: #eee;
        border-radius: 20px;
        padding: 4px;
        display: flex;
        margin-bottom: 25px;
    }
    .toggle-btn {
        flex: 1;
        border: none;
        background: transparent;
        padding: 6px;
        border-radius: 16px;
        font-weight: 600;
        font-size: 0.9em;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
    }
    .toggle-btn.active {
        background-color: white;
        color: var(--primary-green);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* RESUMEN (LOS 3 C√çRCULOS) */
    .summary-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        text-align: center;
    }
    .stat-item { flex: 1; display: flex; flex-direction: column; align-items: center; }
    
    /* C√≠rculo relleno (Intensidad) */
    .circle-filled {
        width: 60px; height: 60px;
        background-color: #8bc34a; /* Verde claro */
        border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        flex-direction: column;
        color: #1a4d1a;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    /* C√≠rculo borde (Porcentajes) */
    .circle-border {
        width: 54px; height: 54px;
        border: 3px solid #8bc34a;
        border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
    }
    
    .stat-label { font-size: 0.75em; color: #666; line-height: 1.2; max-width: 80px; }
    .unit { font-size: 0.7em; font-weight: normal; }

    /* GR√ÅFICO */
    .chart-section h4 { margin: 0 0 10px 0; font-size: 1em; color: #333; }
    .chart-wrapper { height: 250px; width: 100%; position: relative; }

    /* LISTA DE TECNOLOG√çAS (ESTILO TABLA) */
    .tech-list { margin-top: 20px; font-size: 0.9em; }
    .tech-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .tech-icon { margin-right: 10px; width: 20px; text-align: center; }
    .tech-name { flex: 1; }
    .tech-val { font-weight: bold; color: #666; }

    /* MAPA */
    #map { flex: 1; background: #aadaff; }
    
    /* PESTA√ëAS */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

</style>
</head>
<body>

    <div id="sidebar">
    <div class="sidebar-header">
        <div class="header-title" id="header-title-text" style="display: flex; align-items: center;">
    <img src="https://cdn-icons-png.flaticon.com/512/197/197586.png" 
         alt="Chile Flag" 
         style="width: 24px; height: 24px; margin-right: 10px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
         
    Sistema El√©ctrico Nacional
</div>
        
    </div>

    <div class="sidebar-content">
        <div class="toggle-container">
            <button id="btn-elec" class="toggle-btn active" onclick="cambiarPestana('elec')">Electricidad</button>
            <button id="btn-emis" class="toggle-btn" onclick="cambiarPestana('emis')">Emisiones</button>
        </div>

        <div id="view-elec" class="tab-content active">
            
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="circle-filled">
                        <span>--</span>
                        <span class="unit">gCO‚ÇÇ</span>
                    </div>
                    <span class="stat-label">Intensidad de carbono</span>
                </div>
                <div class="stat-item">
                    <div class="circle-border">--%</div>
                    <span class="stat-label">Baja en emisiones</span>
                </div>
                <div class="stat-item">
                    <div class="circle-border" style="border-color: #009688;">--%</div>
                    <span class="stat-label">Renovables</span>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div class="chart-section">
                <h4 id="chart-title">Costo Marginal</h4>
    
                <div id="zoom-container" style="display:none; align-items: center; margin-bottom: 10px; font-size: 0.8em; color: #666;">
                    <span style="margin-right: 10px;">Hist√≥rico</span>
                    <input type="range" id="timeSlider" min="0" max="100" value="100" style="flex: 1; cursor: pointer;">
                    <span style="margin-left: 10px;">Hora</span>
                </div>

                <div id="elec-placeholder" style="text-align: center; padding: 40px; color: #999;">
                    <p>Selecciona una subestaci√≥n en el mapa</p>
                </div>
                
                <div id="chart-container" class="chart-wrapper" style="display: none;">
                    <canvas id="chartCMg"></canvas>
                </div>
                <div id="elec-details" style="text-align: right; font-size: 0.8em; color: #888; margin-top: 5px;"></div>
            </div>

            <div class="tech-list">
                <div style="font-weight: bold; margin-bottom: 10px; font-size: 0.85em; color: #888;">CAPACIDAD INSTALADA (Ejemplo)</div>
                <div class="tech-item"><span class="tech-icon">‚òÄÔ∏è</span> <span class="tech-name">Solar</span> <span class="tech-val">--</span></div>
                <div class="tech-item"><span class="tech-icon">üå¨Ô∏è</span> <span class="tech-name">E√≥lica</span> <span class="tech-val">--</span></div>
                <div class="tech-item"><span class="tech-icon">üíß</span> <span class="tech-name">Hidroel√©ctrica</span> <span class="tech-val">--</span></div>
                <div class="tech-item"><span class="tech-icon">üî•</span> <span class="tech-name">T√©rmica</span> <span class="tech-val">--</span></div>
            </div>

        </div>

        <div id="view-emis" class="tab-content">
    
    <div class="chart-section">
        <h4 style="display:flex; align-items:center;">
            <span style="font-size:1.2em; margin-right:8px;">üè≠</span> 
            <span id="title-emis-co2">Emisiones Medias Horarias (tCO‚ÇÇ)</span>
        </h4>
        
        <div id="zoom-container-co2" style="display:none; align-items: center; margin-bottom: 10px; font-size: 0.8em; color: #666;">
            <span id="inicio-tag-em" style="margin-right: 10px;">.</span>
            <input type="range" id="sliderEmisCO2" min="0" max="100" value="100" style="flex: 1; cursor: pointer;">
            <span id="fin-tag-em" style="margin-left: 10px;">.</span>
        </div>

        <div id="placeholder-co2" style="text-align: center; padding: 30px; color: #999;">
            <p>Cargando emisiones...</p>
        </div>
        
        <div id="chart-box-co2" class="chart-wrapper" style="display: none; height: 250px;">
            <canvas id="canvasEmisCO2"></canvas>
        </div>
        <div id="details-co2" style="text-align: right; font-size: 0.8em; color: #888;"></div>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 30px 0;">

    <div class="chart-section">
        <h4 style="display:flex; align-items:center;">
            <span style="font-size:1.2em; margin-right:8px;">‚ö°</span> 
            <span id="title-gen-real">Generaci√≥n Real Horaria (MW)</span>
        </h4>

        <div id="zoom-container-gen" style="display:none; align-items: center; margin-bottom: 10px; font-size: 0.8em; color: #666;">
            <span id="inicio-tag-ge" style="margin-right: 10px;">2024-08-01</span>
            <input type="range" id="sliderGenReal" min="0" max="100" value="100" style="flex: 1; cursor: pointer;">
            <span id="fin-tag-ge" style="margin-left: 10px;">Hora</span>
        </div>

        <div id="placeholder-gen" style="text-align: center; padding: 30px; color: #999;">
            <p>Cargando generaci√≥n...</p>
        </div>
        
        <div id="chart-box-gen" class="chart-wrapper" style="display: none; height: 250px;">
            <canvas id="canvasGenReal"></canvas>
        </div>
        <div id="details-gen" style="text-align: right; font-size: 0.8em; color: #888;"></div>
    </div>

</div>
    </div>
</div>

<div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // ---------------------------------------------------------
    // 1. CONFIGURACI√ìN DEL MAPA
    // ---------------------------------------------------------
    var capaClaro = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬©OpenStreetMap, ¬©CartoDB' });
    var capaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });

    var limitesChile = [[-60.0, -85.0], [-15.0, -60.0]];

    var map = L.map('map', {
        center: [-33.45, -70.66], 
        zoom: 8,
        minZoom: 5,
        maxBounds: limitesChile,
        maxBoundsViscosity: 1.0,
        layers: [capaSatelite] 
    });

    var baseMaps = { "Mapa Claro": capaClaro, "Sat√©lite": capaSatelite };
    L.control.layers(baseMaps).addTo(map);

    // --- VARIABLES GLOBALES ---
    var graficoActual = null; 
    const API_BASE = "http://186.64.120.248:8000/api/v1";
    var todosLosMarcadores = [];

    // ---------------------------------------------------------
    // 2. FUNCI√ìN PARA CAMBIAR PESTA√ëAS (NUEVO)
    // ---------------------------------------------------------
    function cambiarPestana(tabName) {
        // Quitar active a todos
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Poner active al seleccionado
        document.getElementById('btn-' + tabName).classList.add('active');
        document.getElementById('view-' + tabName).classList.add('active');
    }

    // ---------------------------------------------------------
    // 3. CARGAR SUBESTACIONES
    // ---------------------------------------------------------
    var rutaIcono = '/static/img/iconos_energ_2.svg';
    
    var iconMini = L.icon({ iconUrl: rutaIcono, iconSize: [5, 8], iconAnchor: [2, 8] });
    var iconMedio = L.icon({ iconUrl: rutaIcono, iconSize: [12, 20], iconAnchor: [6, 20], popupAnchor: [1, -15] });
    var iconNormal = L.icon({ iconUrl: rutaIcono, iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] });

    fetch(`${API_BASE}/bus`)
        .then(response => response.json())
        .then(listaSubestaciones => {
            console.log("Subestaciones cargadas:", listaSubestaciones.length);
            listaSubestaciones.forEach(bus => {
                if (bus.lat && bus.lon) {
                    var marker = L.marker([bus.lat, bus.lon], { icon: iconMini }).addTo(map);
                    marker.bindTooltip(bus.nombre);
                    marker.on('click', () => { cargarDatosCMg(bus.id, bus.nombre); });
                    todosLosMarcadores.push(marker);
                }
            });
            actualizarTamanoMarcadores();
        })
        .catch(err => console.error("Error cargando buses:", err));

    // ZOOM DIN√ÅMICO
    map.on('zoomend', function() { actualizarTamanoMarcadores(); });

    function actualizarTamanoMarcadores() {
        var zoomActual = map.getZoom();
        var iconNuevos;
        if (zoomActual < 6) iconNuevos = iconMini;
        else if (zoomActual >= 6 && zoomActual < 10) iconNuevos = iconMedio;
        else iconNuevos = iconNormal;

        todosLosMarcadores.forEach(marker => { marker.setIcon(iconNuevos); });
    }

    // ---------------------------------------------------------
    // 4. CARGAR DATOS (MODIFICADO PARA NO BORRAR BOTONES)
    // ---------------------------------------------------------
    function cargarDatosCMg(id, nombreSubestacion) {
        // 1. Actualizamos el T√≠tulo sin borrar el HTML
        var titulo = document.getElementById('header-title-text').innerText;
        if(titulo) titulo.innerText = nombreSubestacion;

        // 2. Indicamos carga en la zona de detalles
        var detalles = document.getElementById('elec-details');
        detalles.innerHTML = '<small>Cargando datos...</small>';

        // 3. Llamada API
        fetch(`${API_BASE}/cmg?id=${id}`)
            .then(res => res.json())
            .then(data => {
                dibujarGrafico(data);
            })
            .catch(err => {
                console.error(err);
                detalles.innerHTML = `<p style="color:red">Error cargando datos para ID ${id}</p>`;
            });
    }

    // ---------------------------------------------------------
    // 5. DIBUJAR GR√ÅFICO (MODIFICADO)
    // ---------------------------------------------------------
    // Variable para guardar los datos originales completos de la API
    var datosCompletosAPI = null;

    function dibujarGrafico(dataApi) {
        // 1. Mostrar contenedores
        document.getElementById('elec-placeholder').style.display = 'none';
        document.getElementById('chart-container').style.display = 'block';
        document.getElementById('zoom-container').style.display = 'flex'; 
        
        document.getElementById('elec-details').innerHTML = `<small>Unidad: ${dataApi.y_unit} / ${dataApi.x_unit}</small>`;

        // 2. Procesar datos (Timestamp)
        datosCompletosAPI = dataApi.date.map((fecha, i) => ({
            x: new Date(fecha).getTime(), 
            y: dataApi.cmg[i]
        }));


        

        // --- CAMBIO 1: CALCULAR EL TECHO DEL EJE Y ---
        // Buscamos el valor m√°s alto en todo el historial
        var valorMaximo = Math.max(...dataApi.cmg);
        
        // Le agregamos un 20% extra y redondeamos hacia arriba
        // Esto evita que la l√≠nea toque el borde superior
        var techoEjeY = Math.ceil(valorMaximo * 1.2);

        var ctx = document.getElementById('chartCMg').getContext('2d');
        if (graficoActual) graficoActual.destroy();

        // 3. Configuraci√≥n del gr√°fico
        graficoActual = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Costo Marginal',
                    data: datosCompletosAPI, 
                    borderColor: '#2e7d32',  
                    backgroundColor: 'rgba(46, 125, 50, 0.1)',
                    borderWidth: 2,
                    pointRadius: 0,          
                    pointHoverRadius: 4,
                    fill: true,
                    tension: 0.2             
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 600, easing: 'easeOutQuart' },
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)', 
                        titleColor: '#333',
                        bodyColor: '#333',
                        borderColor: '#ddd',
                        borderWidth: 1,
                        callbacks: {
                            title: function(context) {
                                const date = new Date(context[0].parsed.x);
                                return date.toLocaleString('es-CL', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'});
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time', 
                        time: {
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'd MMM',
                                month: 'MMM yyyy'
                            }
                        },
                        grid: { display: false, drawBorder: false },
                        ticks: { 
                            maxRotation: 0, autoSkip: true, maxTicksLimit: 6,
                            color: '#999', font: { size: 11 }
                        }
                    },
                    // --- CAMBIO 2: APLICAR EL TECHO AL EJE Y ---
                    y: {
                        beginAtZero: true,
                        max: techoEjeY, // <--- Aqu√≠ forzamos el l√≠mite superior calculado
                        grid: { color: '#f5f5f5' },
                        ticks: { color: '#999', maxTicksLimit: 5 }
                    }
                }
            }
        });

        // 4. Iniciar Slider
        var slider = document.getElementById('timeSlider');
        slider.value = 0; 
        slider.oninput = function() { aplicarZoom(this.value); };
        aplicarZoom(0);
    }

    // --- L√ìGICA DEL ZOOM (Din√°mica: De 24h a Total Hist√≥rico) ---
    function aplicarZoom(valorSlider) {
        // Validaci√≥n de seguridad
        if (!graficoActual || !datosCompletosAPI || datosCompletosAPI.length === 0) return;

        // 1. Obtener fechas extremas de tus datos reales
        var ultimoPunto = datosCompletosAPI[datosCompletosAPI.length - 1];
        var primerPunto = datosCompletosAPI[0];
        
        var fechaFin = ultimoPunto.x;          // Fecha m√°s reciente
        var fechaInicioHist = primerPunto.x;   // Fecha m√°s antigua

        // 2. Calcular el rango total disponible en horas (Diferencia entre fin e inicio)
        var totalHorasDisponibles = (fechaFin - fechaInicioHist) / (1000 * 60 * 60);

        // 3. Calcular cu√°ntas horas queremos ver seg√∫n la posici√≥n del slider
        // Si slider es 100 (Derecha) -> Vemos solo 24 horas
        // Si slider es 0   (Izquierda) -> Vemos TODO el historial (totalHorasDisponibles)
        var horasAVisualizar = 24 + (totalHorasDisponibles - 24) * ((100 - valorSlider) / 100);

        // 4. Calcular la fecha de inicio de la ventana de visualizaci√≥n
        var fechaInicioVentana = fechaFin - (horasAVisualizar * 60 * 60 * 1000);

        // 5. Aplicar el rango al gr√°fico
        graficoActual.options.scales.x.min = fechaInicioVentana;
        graficoActual.options.scales.x.max = fechaFin;

        // 6. Ajustar etiquetas din√°micamente seg√∫n el zoom
        var timeScale = graficoActual.options.scales.x.time;
        
        if (horasAVisualizar <= 48) { 
            // Zoom muy cerca (menos de 2 d√≠as) -> Muestra HORAS
            timeScale.unit = 'hour';
            timeScale.displayFormats.hour = 'HH:mm'; 
        } else if (horasAVisualizar <= 2000) { 
            // Zoom medio (menos de ~3 meses) -> Muestra D√çAS
            timeScale.unit = 'day';
            timeScale.displayFormats.day = 'd MMM'; 
        } else { 
            // Zoom lejos (m√°s de 3 meses) -> Muestra MESES
            timeScale.unit = 'month';
            timeScale.displayFormats.month = 'MMM yyyy';
        }

        graficoActual.update();
    }
    // --- VARIABLES GLOBALES PARA LA PESTA√ëA DE EMISIONES ---
    // Gr√°fico 1: CO2
    var chartCO2 = null;
    var dataCO2 = null;
    
    // Gr√°fico 2: Generaci√≥n
    var chartGen = null;
    var dataGen = null;

    var datosCargadosEmis = false;

    // 1. FUNCI√ìN DE CARGA (Llama a las 2 APIs)
    function cargarDatosEmisiones() {
        // Fechas fijas seg√∫n tu ejemplo (puedes hacerlas din√°micas luego)
        var start = "2024-08-01 00:00:00";
        var end = "2024-08-08 23:59:00";
        var params = `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;

        // URLs
        var urlCO2 = `${API_BASE}/emisiones_medias_horaria${params}`;
        var urlGen = `${API_BASE}/gen_real_horaria${params}`;

       

        // Llamamos a las dos APIs en paralelo
        Promise.all([
            fetch(urlCO2).then(r => r.json()),
            fetch(urlGen).then(r => r.json())
        ])
        .then(([respCO2, respGen]) => {
            datosCargadosEmis = true;
            
            // Dibujamos el de CO2 (Arriba)
            inicializarGrafico(
                'canvasEmisCO2', 'placeholder-co2', 'chart-box-co2', 'zoom-container-co2', 'sliderEmisCO2',
                respCO2, 
                '#5d4037', // Color Caf√©/Gris oscuro para CO2
                'chartCO2', // Referencia variable global (como string para logica interna)
                'tCO‚ÇÇ'
            );

             // Carlos
            inicio_tag = document.getElementById('inicio-tag-em');
            inicio_tag.innerHTML = respCO2.date[0].substring(0,10)
            fin_tag = document.getElementById('fin-tag-em');
            tam = respCO2.date.length
            fin_tag.innerHTML = respCO2.date[tam - 1].substring(0,10)

            // Dibujamos el de Generaci√≥n (Abajo)
            inicializarGrafico(
                'canvasGenReal', 'placeholder-gen', 'chart-box-gen', 'zoom-container-gen', 'sliderGenReal',
                respGen, 
                '#2e7d32', // Color Verde para Generaci√≥n
                'chartGen',
                'MW'
            );
            inicio_tag = document.getElementById('inicio-tag-ge');
            inicio_tag.innerHTML = respGen.date[0].substring(0,10)
            fin_tag = document.getElementById('fin-tag-ge');
            tam = respGen.date.length
            fin_tag.innerHTML = respGen.date[tam - 1].substring(0,10)
        })
        .catch(err => {
            console.error("Error cargando datos emisiones:", err);
            document.getElementById('placeholder-co2').innerHTML = "<p style='color:red'>Error de conexi√≥n</p>";
            document.getElementById('placeholder-gen').innerHTML = "<p style='color:red'>Error de conexi√≥n</p>";
        });
    }

    // 2. FUNCI√ìN GEN√âRICA PARA DIBUJAR (T√≠tulos compactos)
    function inicializarGrafico(canvasId, placeId, boxId, zoomId, sliderId, dataApi, colorLinea, chartVarName, unidadDefault) {
        
        document.getElementById(placeId).style.display = 'none';
        document.getElementById(boxId).style.display = 'block';
        document.getElementById(zoomId).style.display = 'flex';

        // --- DETECCI√ìN DE DATOS ---
        var valueKey = Object.keys(dataApi).find(k => Array.isArray(dataApi[k]) && k !== 'date');
        var valores = dataApi[valueKey];
        var fechas = dataApi.date;
        var nombreSerie = dataApi.name || "Datos";

        var datosProcesados = fechas.map((f, i) => ({
            x: new Date(f).getTime(),
            y: valores[i]
        }));

        if (chartVarName === 'chartCO2') dataCO2 = datosProcesados;
        if (chartVarName === 'chartGen') dataGen = datosProcesados;

        var ctx = document.getElementById(canvasId).getContext('2d');
        
        if (chartVarName === 'chartCO2' && chartCO2) chartCO2.destroy();
        if (chartVarName === 'chartGen' && chartGen) chartGen.destroy();

        var maxVal = Math.max(...valores);
        var techoY = Math.ceil(maxVal * 1.2);

        var newChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: nombreSerie,
                    data: datosProcesados,
                    borderColor: colorLinea,
                    backgroundColor: colorLinea + '1A', 
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                // Layout ajustado para aprovechar espacio
                layout: {
                    padding: { left: 0, right: 10, top: 0, bottom: 0 }
                },
                animation: { duration: 600, easing: 'easeOutQuart' },
                interaction: { mode: 'nearest', axis: 'x', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#333', bodyColor: '#333', borderColor: '#ccc', borderWidth: 1,
                        callbacks: {
                            title: function(c) {
                                const d = new Date(c[0].parsed.x);
                                return d.toLocaleString('es-CL', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'});
                            },
                            label: function(c) {
                                return ` ${c.parsed.y.toLocaleString('es-CL')} ${unidadDefault}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { displayFormats: { hour: 'HH:mm', day: 'd MMM' } },
                        grid: { display: false, drawBorder: false },
                        
                        // Ticks peque√±os
                        ticks: { 
                            maxRotation: 0, 
                            autoSkip: true, 
                            maxTicksLimit: 6, 
                            color: '#999', 
                            font: { size: 9 }, // Fuente peque√±a
                            padding: 2         // Pegado a la l√≠nea
                        },
                        
                        // --- TITULO EJE X (Compacto) ---
                        title: { 
                            display: true,
                            text: 'Fecha/Hora',
                            color: '#aaa',
                            font: { size: 10 }, // Muy discreto
                            padding: { top: 2, bottom: 0 } // Casi sin margen
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: techoY,
                        grid: { color: '#f5f5f5', drawBorder: false },
                        
                        // Ticks pegados al eje
                        ticks: { 
                            color: '#999', 
                            maxTicksLimit: 5, 
                            font: { size: 9 },
                            padding: 2  // Reduce el espacio entre el n√∫mero y el gr√°fico
                        },

                        // --- TITULO EJE Y (Compacto) ---
                        title: { 
                            display: true,
                            text: unidadDefault, // tCO2 o MW
                            color: '#aaa',
                            font: { size: 10, weight: 'bold' }, // Fuente peque√±a
                            padding: 0 // <--- ESTO ES CLAVE: Quita el "aire" extra alrededor del t√≠tulo
                        }
                    }
                }
            }
        });

        if (chartVarName === 'chartCO2') chartCO2 = newChart;
        if (chartVarName === 'chartGen') chartGen = newChart;

        var slider = document.getElementById(sliderId);
        slider.value = 100;
        slider.oninput = function() { 
            aplicarZoomGenerico(this.value, chartVarName); 
        };
        
        aplicarZoomGenerico(100, chartVarName);
    }

    // 3. L√ìGICA DE ZOOM COMPARTIDA
    function aplicarZoomGenerico(valorSlider, chartVarName) {
        var chart, dataFull;
        
        if (chartVarName === 'chartCO2') { chart = chartCO2; dataFull = dataCO2; }
        else { chart = chartGen; dataFull = dataGen; }

        if (!chart || !dataFull || dataFull.length === 0) return;

        var total = dataFull.length;
        var ultimo = dataFull[total - 1];
        var fechaFin = ultimo.x;

        // L√≥gica de Zoom: 100% = 24h, 0% = Total disponible (aprox 1 semana en tu caso)
        // Calculamos rango total en horas de los datos disponibles
        var rangoTotalHoras = (fechaFin - dataFull[0].x) / 36e5; 
        
        // Interpolaci√≥n lineal
        var horasVer = 24 + (rangoTotalHoras - 24) * ((100 - valorSlider) / 100);
        var fechaInicio = fechaFin - (horasVer * 36e5);

        chart.options.scales.x.min = fechaInicio;
        chart.options.scales.x.max = fechaFin;

        // Ajuste etiquetas
        var timeScale = chart.options.scales.x.time;
        if (horasVer <= 48) {
            timeScale.unit = 'hour'; 
        } else {
            timeScale.unit = 'day'; 
        }

        chart.update();
    }
    // Forzamos la carga inmediata de los datos nacionales
    console.log("Iniciando carga autom√°tica de emisiones...");
    cargarDatosEmisiones(); 

</script>
</script>
</body>
</html>